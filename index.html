<!doctype html>
<html lang=fr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Gestion des Notes — Bleu/Blanc (Autonome)</title>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js></script>
<style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:Inter,"Segoe UI",Roboto,Arial,sans-serif;background:#f4f8ff;color:#06243a}.container{max-width:1200px;margin:18px auto;padding:16px}.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff}.brand{display:flex;align-items:center;gap:12px}.logo-inline{display:flex;gap:8px;align-items:center}.logo-inline img{width:52px;height:52px;border-radius:6px;background:#fff;padding:6px;object-fit:contain}.brand h1{font-size:18px;margin:0}.top-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.top-actions input[type=file]{display:inline-block}.top-actions button{padding:8px 12px;border-radius:8px;border:0;background:#fff;color:#1e40af;font-weight:700;cursor:pointer}.grid{display:grid;grid-template-columns:380px 1fr;gap:16px;margin-top:18px}@media(max-width:920px){.grid{grid-template-columns:1fr}}.card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 8px 22px rgba(15,23,42,.06)}.small-label{display:block;font-weight:700;margin-bottom:6px;color:#123049}input[type=number],input[type=text],select{padding:8px;border-radius:8px;border:1px solid #e6eefc;width:100%}.form-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}.notes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:10px}.note-item{display:flex;flex-direction:column}.note-item label{font-weight:600;font-size:13px;margin-bottom:6px;color:#23475a}.actions{display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap}.btn{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer;font-weight:700}.btn.ghost{background:0 0;border:1px solid #2563eb;color:#2563eb}.btn.warn{background:#ef4444}.btn.neutral{background:#0ea5e9}.avg-box{margin-left:auto;font-weight:800;color:#0f172a}.table-wrap{overflow:auto;margin-top:10px}table{width:100%;border-collapse:collapse;min-width:820px}td,th{padding:8px;border-bottom:1px solid #eef6ff;text-align:center}thead th{background:#f1f7ff;font-weight:800;position:sticky;top:0}tbody tr:hover{background:#f8fafc;cursor:pointer}tbody tr.selected{background:#fff7cc}.context-badge{display:inline-block;background:#e6f0ff;color:#08325a;padding:6px 10px;border-radius:999px;font-weight:700;margin-left:8px}footer{padding:12px;text-align:center;color:#5b6b7a;margin-top:18px}@media(max-width:700px){.notes-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}}.col-actions{position:sticky;right:0;background:#fff}.mini{padding:4px 8px;border-radius:6px;font-weight:700;border:1px solid #dbeafe;background:#eff6ff;color:#1d4ed8;cursor:pointer}</style>
</head>
<body>
<div class=container>
<header class=topbar>
<div class=brand>
<div class=logo-inline>
<svg id=logoBook width=52 height=52 viewBox="0 0 64 64" xmlns=http://www.w3.org/2000/svg style=border-radius:6px;background:#fff;padding:6px>
<rect rx=10 width=64 height=64 fill=#ffffff00 />
<path d="M8 14c8-4 18-4 28 0 10-4 20-4 28 0v32c-8-4-18-4-28 0-10-4-20-4-28 0V14z" fill=#1e3a8a />
<path d="M12 18c6-2.5 14-2.5 22 0 8-2.5 16-2.5 22 0v24c-6-2.5-14-2.5-22 0C26 39.5 18 39.5 12 37V18z" fill=#3b82f6 />
</svg>
<svg id=logoSen width=36 height=24 viewBox="0 0 15 10" xmlns=http://www.w3.org/2000/svg style=border-radius:4px;overflow:visible>
<rect width=5 height=10 x=0 y=0 fill=#009E60 />
<rect width=5 height=10 x=5 y=0 fill=#FDEF42 />
<rect width=5 height=10 x=10 y=0 fill=#CE1126 />
<polygon points="7.5,3.5 8.1,4.9 9.7,5 8.5,6.1 8.9,7.7 7.5,6.8 6.1,7.7 6.5,6.1 5.3,5 6.9,4.9" fill=#006400 />
</svg>
</div>
<div>
<h1>Gestion des Notes — Bleu / Blanc</h1>
<div style=font-size:13px;opacity:.95>Primaire • Collège • Lycée — matières par classe</div>
</div>
</div>
<div class=top-actions>
<label style=color:#fff;font-weight:700>Logo (PDF)</label>
<input id=logoInput type=file accept=image/*>
<label style=color:#fff;font-weight:700>Signature</label>
<input id=sigInput type=file accept=image/*>
<button id=importCsv class="btn ghost" title="Importer un CSV exporté">Importer CSV</button>
<button id=exportCsv class="btn ghost">Exporter CSV</button>
<button id=exportPdf class=btn>Exporter PDF (Classe)</button>
<button id=exportZip class="btn neutral" title="Toutes les fiches élèves">Exporter fiches (ZIP)</button>
</div>
</header>
<main class=grid>
<section class=card>
<div style=margin-bottom:8px>
<label class=small-label>Parcours</label>
<select id=selectCourse></select>
</div>
<div style=margin-bottom:8px>
<label class=small-label>Classe</label>
<select id=selectClass></select>
</div>
<hr style="margin:10px 0">
<div>
<div class=form-row>
<div style=flex:1>
<label class=small-label>Prénom</label>
<input id=firstName placeholder=Prénom>
</div>
<div style=flex:1>
<label class=small-label>Nom</label>
<input id=lastName placeholder=Nom>
</div>
</div>
<div class=form-row>
<div style=width:130px>
<label class=small-label>Sexe</label>
<select id=sex><option>Garçon</option><option>Fille</option></select>
</div>
<div style=width:110px>
<label class=small-label>Âge</label>
<input id=age type=number min=4 max=25 value=10>
</div>
<div style=flex:1>
<label class=small-label>Scolarité</label>
<select id=schooling><option>Régulier</option><option>Redoublant</option></select>
</div>
</div>
<h4 style=margin-top:12px>Matières — saisie des notes</h4>
<div id=notesGrid class=notes-grid aria-live=polite></div>
<div class=actions>
<button id=btnAdd class=btn>Ajouter / Enregistrer</button>
<button id=btnUpdate class="btn ghost" disabled>Mettre à jour</button>
<button id=btnDelete class="btn warn" disabled>Supprimer</button>
<button id=btnStudentPdf class="btn neutral" disabled>Fiche élève (PDF)</button>
<div class=avg-box id=avgBox>Moyenne : — /10</div>
</div>
</div>
</section>
<section class=card>
<div style=display:flex;align-items:center;justify-content:space-between>
<h3 style=margin:0>Élèves <span id=contextBadge class=context-badge></span></h3>
<div>
<input id=search placeholder="Rechercher nom/prénom" style="padding:8px;border-radius:8px;border:1px solid #e6eefc">
</div>
</div>
<div class=table-wrap style=margin-top:10px>
<table id=studentsTable>
<thead><tr id=tableHead></tr></thead>
<tbody></tbody>
</table>
</div>
</section>
</main>
<footer>Les données sont stockées localement dans ton navigateur (localStorage).</footer>
</div>
<script>const SUBJECTS={Primaire:{classes:["CI","CP","CE1","CE2","CM1","CM2"],byClass:{CI:[{code:"PE",label:"PE",max:10},{code:"ECR",label:"Écr",max:10},{code:"COPIE",label:"Copie",max:10},{code:"AUTD",label:"Autod",max:10},{code:"LECT",label:"Lect",max:10},{code:"CHANT",label:"Chant",max:10},{code:"NUM",label:"Numé",max:10},{code:"MES",label:"Mes",max:10},{code:"GEOM",label:"Géom",max:10},{code:"RP",label:"RP",max:10},{code:"HIST",label:"Hist",max:10},{code:"GEO",label:"Géo",max:10},{code:"IST",label:"Ist",max:10},{code:"VE",label:"VE",max:10},{code:"VDSM",label:"VDSM",max:10},{code:"AP",label:"AP",max:10},{code:"AR",label:"Arts",max:10}],CP:[],CE1:[{code:"LCR",label:"LCR",max:40},{code:"LCC",label:"LCC",max:40},{code:"MR",label:"MR",max:40},{code:"MC",label:"MC",max:60},{code:"AP",label:"AP",max:10},{code:"LECT",label:"Lecture",max:10},{code:"CHANT",label:"Chant",max:10},{code:"DMR",label:"DMR",max:20},{code:"DMC",label:"DMC",max:20},{code:"EDDR",label:"EDDR",max:20},{code:"EDDC",label:"EDDC",max:20}],CE2:[],CM1:[{code:"TSQ",label:"TSQ",max:40},{code:"PE",label:"PE",max:60},{code:"MR",label:"MR",max:40},{code:"MC",label:"MC",max:60},{code:"DM",label:"DM",max:40},{code:"EDD",label:"EDD",max:40},{code:"AR",label:"AR",max:10},{code:"AP",label:"AP",max:10}],CM2:[]}},"Collège":{classes:["6e","5e","4e","3e"],byClass:{"6e":[{code:"FR_RED",label:"Français — Rédaction",max:20,coef:2},{code:"FR_TSQ",label:"Français — TSQ",max:20,coef:1},{code:"FR_ORTH",label:"Français — Orthographe",max:20,coef:1},{code:"MATH",label:"Mathématiques",max:20,coef:3},{code:"ANG",label:"Anglais",max:20,coef:2},{code:"HG",label:"Histoire-Géo",max:20,coef:2},{code:"ESP",label:"Espagnol",max:20,coef:2},{code:"PC",label:"Physique-Chimie",max:20,coef:2},{code:"SVT",label:"SVT",max:20,coef:2},{code:"EPS",label:"EPS",max:20,coef:2},{code:"IC",label:"Informatique (IC)",max:20,coef:1},{code:"MUS",label:"Musique",max:20,coef:1},{code:"COND",label:"Conduite",max:20,coef:1}],"5e":[],"4e":[],"3e":[]}},"Lycée":{classes:["2nde","1ère","Terminale"],byClass:{"2nde":[{code:"FR",label:"Français",max:20,coef:1},{code:"PHIL",label:"Philosophie",max:20,coef:1},{code:"MATH",label:"Mathématiques",max:20,coef:1},{code:"SVT",label:"SVT",max:20,coef:1},{code:"PC",label:"Physique-Chimie",max:20,coef:1},{code:"HG",label:"Histoire-Géo",max:20,coef:1},{code:"ANG",label:"Anglais",max:20,coef:1},{code:"EPS",label:"EPS",max:20,coef:1}],"1ère":[],Terminale:[]}}};SUBJECTS.Primaire.byClass.CP=JSON.parse(JSON.stringify(SUBJECTS.Primaire.byClass.CI)),SUBJECTS.Primaire.byClass.CE2=JSON.parse(JSON.stringify(SUBJECTS.Primaire.byClass.CE1)),SUBJECTS.Primaire.byClass.CM2=JSON.parse(JSON.stringify(SUBJECTS.Primaire.byClass.CM1)),["5e","4e","3e"].forEach((e=>{0===SUBJECTS["Collège"].byClass[e].length&&(SUBJECTS["Collège"].byClass[e]=JSON.parse(JSON.stringify(SUBJECTS["Collège"].byClass["6e"])))})),["1ère","Terminale"].forEach((e=>{0===SUBJECTS["Lycée"].byClass[e].length&&(SUBJECTS["Lycée"].byClass[e]=JSON.parse(JSON.stringify(SUBJECTS["Lycée"].byClass["2nde"])))}));const STORAGE_KEY="grades_app_autonome_v2";let STORE=JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");STORE||(STORE={records:{},logoDataUrl:null,sigDataUrl:null},localStorage.setItem(STORAGE_KEY,JSON.stringify(STORE)));const selectCourse=document.getElementById("selectCourse"),selectClass=document.getElementById("selectClass"),notesGrid=document.getElementById("notesGrid"),tableHead=document.getElementById("tableHead"),studentsTbody=document.querySelector("#studentsTable tbody"),contextBadge=document.getElementById("contextBadge"),avgBox=document.getElementById("avgBox"),firstNameEl=document.getElementById("firstName"),lastNameEl=document.getElementById("lastName"),sexEl=document.getElementById("sex"),ageEl=document.getElementById("age"),schoolEl=document.getElementById("schooling"),btnAdd=document.getElementById("btnAdd"),btnUpdate=document.getElementById("btnUpdate"),btnDelete=document.getElementById("btnDelete"),btnStudentPdf=document.getElementById("btnStudentPdf"),exportCsvBtn=document.getElementById("exportCsv"),importCsvBtn=document.getElementById("importCsv"),exportPdfBtn=document.getElementById("exportPdf"),exportZipBtn=document.getElementById("exportZip"),logoInput=document.getElementById("logoInput"),sigInput=document.getElementById("sigInput"),searchBox=document.getElementById("search");let currentCourse=null,currentClass=null,selectedIndex=null,currentSort={key:"__rank",dir:-1};function $(e){return document.querySelector(e)}function $$(e){return Array.from(document.querySelectorAll(e))}function saveStore(){localStorage.setItem(STORAGE_KEY,JSON.stringify(STORE))}function ensureRecords(e,t){STORE.records[e]||(STORE.records[e]={}),STORE.records[e][t]||(STORE.records[e][t]=[])}function subjectsFor(e,t){return SUBJECTS[e]?.byClass[t]||[]}function computeAverage(e,t){if(!t||0===t.length)return 0;if("Primaire"===currentCourse){let r=0,a=0;for(const n of t)r+=Number(e[n.code]??0),a+=Number(n.max||0);return 0===a?0:Math.round(r/a*10*100)/100}{let r=0,a=0;for(const n of t){const t=Number(n.coef??1),o=Number(e[n.code]??0),s=Number(n.max||1);r+=(s>0?o/s:0)*t,a+=t}return 0===a?0:Math.round(r/a*10*100)/100}}function assignRanks(e,t){const r=e.map(((e,r)=>({...e,__avg:computeAverage(e.notes||{},t),__origIdx:r})));r.sort(((e,t)=>t.__avg-e.__avg));const a=new Array(r.length);let n=1;for(let e=0;e<r.length;e++)e>0&&r[e].__avg===r[e-1].__avg?a[e]=a[e-1]:a[e]=n,n++;const o={};return r.forEach(((e,t)=>o[e.__origIdx]={avg:e.__avg,rank:a[t]})),o}function rankSuffix(e){return!e||e<1?"":1===e?"1er":e+"e"}function init(){selectCourse.innerHTML="";for(const e of Object.keys(SUBJECTS)){const t=document.createElement("option");t.value=e,t.textContent=e,selectCourse.appendChild(t)}currentCourse=selectCourse.value,populateClasses()}function populateClasses(){selectClass.innerHTML="";(SUBJECTS[currentCourse].classes||[]).forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,selectClass.appendChild(t)})),currentClass=selectClass.value,updateContext(),renderSubjects(),renderTable()}function updateContext(){contextBadge.textContent=`${currentCourse} — ${currentClass}`,ensureRecords(currentCourse,currentClass)}function renderSubjects(){notesGrid.innerHTML="";subjectsFor(currentCourse,currentClass).forEach((e=>{const t=document.createElement("div");t.className="note-item";const r=document.createElement("label");r.textContent=`${e.label} (max ${e.max})`;const a=document.createElement("input");a.type="number",a.min=0,a.max=e.max,a.step="0.01",a.dataset.code=e.code,t.appendChild(r),t.appendChild(a),notesGrid.appendChild(t),a.addEventListener("input",computeAndShowAvg)})),computeAndShowAvg(),buildTableHead()}function buildTableHead(){tableHead.innerHTML="";["Prénom","Nom","Sexe","Âge","Scolarité"].forEach((e=>{const t=document.createElement("th");t.textContent=e,t.dataset.key=e,t.style.cursor="pointer",t.addEventListener("click",(()=>sortByHeader(e))),tableHead.appendChild(t)})),subjectsFor(currentCourse,currentClass).forEach((e=>{const t=document.createElement("th");t.textContent=e.label,t.dataset.code=e.code,t.style.cursor="pointer",t.addEventListener("click",(()=>sortByHeader(e.code))),tableHead.appendChild(t)}));const e=document.createElement("th");e.textContent="Moyenne",e.style.cursor="pointer",e.addEventListener("click",(()=>sortByHeader("__avg"))),tableHead.appendChild(e);const t=document.createElement("th");t.textContent="Rang",tableHead.appendChild(t)}function renderTable(){ensureRecords(currentCourse,currentClass);const e=STORE.records[currentCourse][currentClass];studentsTbody.innerHTML="";const t=subjectsFor(currentCourse,currentClass),r=assignRanks(e,t),a=e.map(((e,a)=>({idx:a,rec:e,avg:r[a]?.avg??computeAverage(e.notes||{},t),rank:r[a]?.rank??0})));a.sort(((e,t)=>t.avg-e.avg||(e.rec.lastName||"").localeCompare(t.rec.lastName||"")));const n=(searchBox.value||"").trim().toLowerCase();a.forEach((e=>{const r=e.rec,a=e.avg,o=e.rank,s=`${r.firstName||""} ${r.lastName||""}`.toLowerCase();if(n&&!s.includes(n)&&!(r.firstName||"").toLowerCase().includes(n)&&!(r.lastName||"").toLowerCase().includes(n))return;const l=document.createElement("tr");l.dataset.index=e.idx;const c=[`<td>${r.firstName||""}</td>`,`<td>${r.lastName||""}</td>`,`<td>${r.gender||""}</td>`,`<td>${r.age??""}</td>`,`<td>${r.schooling||""}</td>`];for(const e of t)c.push(`<td>${r.notes?.[e.code]??""}</td>`);c.push(`<td>${a}</td>`),c.push(`<td>${rankSuffix(o)}</td>`),l.innerHTML=c.join(""),l.addEventListener("click",(()=>selectStudentByIndex(e.idx))),studentsTbody.appendChild(l)})),updateContext()}function selectStudentByIndex(e){ensureRecords(currentCourse,currentClass);const t=STORE.records[currentCourse][currentClass][e];if(!t)return;selectedIndex=e,firstNameEl.value=t.firstName||"",lastNameEl.value=t.lastName||"",sexEl.value=t.gender||"Garçon",ageEl.value=t.age||"",schoolEl.value=t.schooling||"Régulier",subjectsFor(currentCourse,currentClass).forEach((e=>{const r=notesGrid.querySelector(`input[data-code="${e.code}"]`);r&&(r.value=t.notes?.[e.code]??"")})),btnUpdate.disabled=!1,btnDelete.disabled=!1,btnStudentPdf.disabled=!1,$$("#studentsTable tbody tr").forEach((e=>e.classList.remove("selected")));const r=$(`#studentsTable tbody tr[data-index="${e}"]`);r&&r.classList.add("selected"),computeAndShowAvg()}function clearForm(){selectedIndex=null,firstNameEl.value="",lastNameEl.value="",sexEl.value="Garçon",ageEl.value="",schoolEl.value="Régulier",notesGrid.querySelectorAll("input[data-code]").forEach((e=>e.value="")),btnUpdate.disabled=!0,btnDelete.disabled=!0,btnStudentPdf.disabled=!0,$$("#studentsTable tbody tr").forEach((e=>e.classList.remove("selected"))),computeAndShowAvg()}function computeAndShowAvg(){const e=subjectsFor(currentCourse,currentClass),t={};e.forEach((e=>{const r=notesGrid.querySelector(`input[data-code="${e.code}"]`);t[e.code]=r&&""!==r.value?Number(r.value):0}));const r=computeAverage(t,e);avgBox.textContent=`Moyenne : ${r} /10`}function fileToDataUrl(e){return new Promise(((t,r)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=()=>r(),a.readAsDataURL(e)}))}function sortByHeader(e){ensureRecords(currentCourse,currentClass);const t=STORE.records[currentCourse][currentClass],r=subjectsFor(currentCourse,currentClass);if(!t||0===t.length)return;const a=t.map(((e,t)=>({r:e,idx:t,avg:computeAverage(e.notes||{},r)})));let n;n="Prénom"===e?(e,t)=>e.r.firstName.localeCompare(t.r.firstName):"Nom"===e?(e,t)=>e.r.lastName.localeCompare(t.r.lastName):"Sexe"===e?(e,t)=>(e.r.gender||"").localeCompare(t.r.gender||""):"Âge"===e?(e,t)=>Number(e.r.age||0)-Number(t.r.age||0):"Scolarité"===e?(e,t)=>(e.r.schooling||"").localeCompare(t.r.schooling||""):"__avg"===e?(e,t)=>e.avg-t.avg:(t,r)=>Number(t.r.notes?.[e]||0)-Number(r.r.notes?.[e]||0),a.sort(((e,t)=>currentSort.dir*n(e,t)));const o=a.map((e=>e.r));STORE.records[currentCourse][currentClass]=o,saveStore(),currentSort.dir=-currentSort.dir,renderTable()}btnAdd.addEventListener("click",(()=>{const e=(firstNameEl.value||"").trim(),t=(lastNameEl.value||"").trim();if(!e||!t)return alert("Prénom et Nom requis");const r=subjectsFor(currentCourse,currentClass),a={};for(const e of r){const t=notesGrid.querySelector(`input[data-code="${e.code}"]`),r=t&&""!==t.value?Number(t.value):0;a[e.code]=Math.max(0,Math.min(e.max,r))}ensureRecords(currentCourse,currentClass),STORE.records[currentCourse][currentClass].push({firstName:e,lastName:t,gender:sexEl.value,age:ageEl.value,schooling:schoolEl.value,notes:a}),saveStore(),renderTable(),clearForm()})),btnUpdate.addEventListener("click",(()=>{if(null===selectedIndex)return alert("Sélectionne un élève");const e=(firstNameEl.value||"").trim(),t=(lastNameEl.value||"").trim();if(!e||!t)return alert("Prénom et Nom requis");const r=subjectsFor(currentCourse,currentClass),a={};for(const e of r){const t=notesGrid.querySelector(`input[data-code="${e.code}"]`),r=t&&""!==t.value?Number(t.value):0;a[e.code]=Math.max(0,Math.min(e.max,r))}ensureRecords(currentCourse,currentClass),STORE.records[currentCourse][currentClass][selectedIndex]={firstName:e,lastName:t,gender:sexEl.value,age:ageEl.value,schooling:schoolEl.value,notes:a},saveStore(),renderTable(),clearForm()})),btnDelete.addEventListener("click",(()=>{if(null===selectedIndex)return alert("Sélectionne un élève");confirm("Supprimer l'élève sélectionné ?")&&(ensureRecords(currentCourse,currentClass),STORE.records[currentCourse][currentClass].splice(selectedIndex,1),saveStore(),renderTable(),clearForm())})),exportCsvBtn.addEventListener("click",(()=>{ensureRecords(currentCourse,currentClass);const e=STORE.records[currentCourse][currentClass]||[];if(0===e.length)return alert("Aucun élève à exporter");const t=subjectsFor(currentCourse,currentClass),r=assignRanks(e,t),a=[["Prénom","Nom","Sexe","Âge","Scolarité",...t.map((e=>e.label)),"Moyenne (/10)","Rang"].join(";"),...e.map(((e,a)=>{const n=r[a]?.avg??computeAverage(e.notes||{},t),o=r[a]?.rank??0;return[...[e.firstName||"",e.lastName||"",e.gender||"",e.age??"",e.schooling||""],...t.map((t=>e.notes?.[t.code]??"")),String(n),rankSuffix(o)].join(";")}))].join("\n"),n=new Blob([a],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=`Notes_${currentCourse}_${currentClass}.csv`.replace(/\s+/g,"_"),o.click(),URL.revokeObjectURL(o.href)})),importCsvBtn.addEventListener("click",(()=>{const e=document.createElement("input");e.type="file",e.accept=".csv,text/csv",e.onchange=async e=>{const t=e.target.files[0];if(!t)return;const r=(await t.text()).split(/\r?\n/).filter(Boolean);if(r.length<2)return alert("CSV vide");const a=r[0].split(";"),n=subjectsFor(currentCourse,currentClass),o=5+n.length;if(a.length<o)return alert("Colonnes manquantes. Exporte un CSV depuis l'app pour avoir le bon format.");ensureRecords(currentCourse,currentClass);const s=[];for(let e=1;e<r.length;e++){const t=r[e].split(";");if(t.length<o)continue;const a={firstName:t[0]||"",lastName:t[1]||"",gender:t[2]||"",age:t[3]||"",schooling:t[4]||"",notes:{}};n.forEach(((e,r)=>{const n=Number(t[5+r]||0);a.notes[e.code]=isNaN(n)?0:n})),(a.firstName||a.lastName)&&s.push(a)}STORE.records[currentCourse][currentClass]=s,saveStore(),renderTable(),clearForm(),alert(`Import terminé: ${s.length} élève(s).`)},e.click()})),exportPdfBtn.addEventListener("click",(()=>{ensureRecords(currentCourse,currentClass);const e=STORE.records[currentCourse][currentClass]||[];if(0===e.length)return alert("Aucun élève à exporter");const t=subjectsFor(currentCourse,currentClass),r=assignRanks(e,t),a=e.map(((e,a)=>({idx:a,rec:e,avg:r[a]?.avg??computeAverage(e.notes||{},t),rank:r[a]?.rank??0})));a.sort(((e,t)=>t.avg-e.avg));const{jsPDF:n}=window.jspdf,o=new n({orientation:"landscape",unit:"pt",format:"a4"}),s=o.internal.pageSize.getWidth(),l=36;if(o.setFillColor(37,99,235),o.rect(0,0,s,64,"F"),STORE.logoDataUrl)try{o.addImage(STORE.logoDataUrl,"PNG",l,10,44,44)}catch(e){try{o.addImage(STORE.logoDataUrl,"JPEG",l,10,44,44)}catch(e){}}const c="data:image/svg+xml;utf8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='36' height='24'><rect width='12' height='24' x='0' y='0' fill='#009E60'/><rect width='12' height='24' x='12' y='0' fill='#FDEF42'/><rect width='12' height='24' x='24' y='0' fill='#CE1126'/><polygon points='18,7 18.6,9.2 20.6,9.4 19.3,10.6 19.7,12.6 18,11.5 16.3,12.6 16.7,10.6 15.4,9.4 17.4,9.2' fill='#006400'/></svg>");try{o.addImage(c,"SVG",s-l-52,10,44,29)}catch(e){}o.setFontSize(18),o.setTextColor(255,255,255),o.text(`Fiche de notes — ${currentCourse} / ${currentClass}`,s/2,28,{align:"center"}),o.setFontSize(10),o.text(`Généré le ${(new Date).toLocaleString()}`,s/2,44,{align:"center"});const d=[["Prénom","Nom","Sexe","Âge","Scolarité",...t.map((e=>e.label)),"Moyenne (/10)","Rang"]],u=a.map((e=>{const r=e.rec;return[r.firstName,r.lastName,r.gender,String(r.age??""),r.schooling,...t.map((e=>String(r.notes?.[e.code]??""))),String(e.avg),rankSuffix(e.rank)]}));o.autoTable({startY:86,head:d,body:u,styles:{fontSize:9,halign:"center",valign:"middle"},headStyles:{fillColor:[37,99,235],textColor:255},alternateRowStyles:{fillColor:[245,246,250]},margin:{left:l,right:l},theme:"grid"});const i=(o.lastAutoTable?.finalY||86)+28;if(o.setFontSize(11),o.setTextColor(0,0,0),o.text("Signature enseignant :",s-l-200,i),STORE.sigDataUrl)try{o.addImage(STORE.sigDataUrl,"PNG",s-l-140,i-12,120,48)}catch(e){try{o.addImage(STORE.sigDataUrl,"JPEG",s-l-140,i-12,120,48)}catch(e){}}else o.line(s-l-160,i+8,s-l-40,i+8);o.save(`Notes_${currentCourse}_${currentClass}.pdf`.replace(/\s+/g,"_"))})),btnStudentPdf.addEventListener("click",(()=>{if(null===selectedIndex)return alert("Sélectionne un élève");ensureRecords(currentCourse,currentClass);const e=STORE.records[currentCourse][currentClass][selectedIndex],t=subjectsFor(currentCourse,currentClass),r=computeAverage(e.notes||{},t),{jsPDF:a}=window.jspdf,n=new a({orientation:"portrait",unit:"pt",format:"a4"}),o=n.internal.pageSize.getWidth(),s=48;if(n.setFillColor(37,99,235),n.rect(0,0,o,68,"F"),STORE.logoDataUrl)try{n.addImage(STORE.logoDataUrl,"PNG",s,14,40,40)}catch(e){try{n.addImage(STORE.logoDataUrl,"JPEG",s,14,40,40)}catch(e){}}const l="data:image/svg+xml;utf8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='36' height='24'><rect width='12' height='24' x='0' y='0' fill='#009E60'/><rect width='12' height='24' x='12' y='0' fill='#FDEF42'/><rect width='12' height='24' x='24' y='0' fill='#CE1126'/><polygon points='18,7 18.6,9.2 20.6,9.4 19.3,10.6 19.7,12.6 18,11.5 16.3,12.6 16.7,10.6 15.4,9.4 17.4,9.2' fill='#006400'/></svg>");try{n.addImage(l,"SVG",o-s-48,14,40,28)}catch(e){}n.setFontSize(18),n.setTextColor(255,255,255),n.text(`Fiche élève — ${currentCourse} / ${currentClass}`,o/2,30,{align:"center"}),n.setFontSize(10),n.text(`Généré le ${(new Date).toLocaleString()}`,o/2,50,{align:"center"}),n.setTextColor(0,0,0),n.setFontSize(12),n.text(`Nom : ${e.lastName}  |  Prénom : ${e.firstName}`,s,96),n.text(`Sexe : ${e.gender||""}  |  Âge : ${e.age||""}  |  Scolarité : ${e.schooling||""}`,s,114);const c=t.map((t=>[t.label,String(e.notes?.[t.code]??""),String(t.max)]));n.autoTable({startY:130,head:[["Matière","Note","Barème"]],body:c,styles:{fontSize:10,halign:"center"},headStyles:{fillColor:[37,99,235],textColor:255},alternateRowStyles:{fillColor:[245,246,250]},margin:{left:s,right:s},theme:"grid"});const d=n.lastAutoTable?.finalY||130;n.setFontSize(14),n.text(`Moyenne générale : ${r} /10`,s,d+24);const u=d+64;if(n.setFontSize(11),n.text("Signature enseignant :",o-s-200,u),STORE.sigDataUrl)try{n.addImage(STORE.sigDataUrl,"PNG",o-s-140,u-12,120,48)}catch(e){try{n.addImage(STORE.sigDataUrl,"JPEG",o-s-140,u-12,120,48)}catch(e){}}else n.line(o-s-160,u+8,o-s-40,u+8);const i=`Fiche_${e.lastName||""}_${e.firstName||""}_${currentClass}.pdf`.replace(/\s+/g,"_");n.save(i)})),exportZipBtn.addEventListener("click",(async()=>{ensureRecords(currentCourse,currentClass);const e=STORE.records[currentCourse][currentClass]||[];if(0===e.length)return alert("Aucun élève");const t=subjectsFor(currentCourse,currentClass),r=new JSZip,{jsPDF:a}=window.jspdf;for(let n=0;n<e.length;n++){const o=e[n],s=new a({orientation:"portrait",unit:"pt",format:"a4"}),l=s.internal.pageSize.getWidth(),c=48;if(s.setFillColor(37,99,235),s.rect(0,0,l,68,"F"),STORE.logoDataUrl)try{s.addImage(STORE.logoDataUrl,"PNG",c,14,40,40)}catch(e){try{s.addImage(STORE.logoDataUrl,"JPEG",c,14,40,40)}catch(e){}}s.setFontSize(18),s.setTextColor(255,255,255),s.text(`Fiche élève — ${currentCourse} / ${currentClass}`,l/2,30,{align:"center"}),s.setFontSize(10),s.text(`Généré le ${(new Date).toLocaleString()}`,l/2,50,{align:"center"}),s.setTextColor(0,0,0),s.setFontSize(12),s.text(`Nom : ${o.lastName}  |  Prénom : ${o.firstName}`,c,96),s.text(`Sexe : ${o.gender||""}  |  Âge : ${o.age||""}  |  Scolarité : ${o.schooling||""}`,c,114);const d=t.map((e=>[e.label,String(o.notes?.[e.code]??""),String(e.max)]));s.autoTable({startY:130,head:[["Matière","Note","Barème"]],body:d,styles:{fontSize:10,halign:"center"},headStyles:{fillColor:[37,99,235],textColor:255},alternateRowStyles:{fillColor:[245,246,250]},margin:{left:c,right:c},theme:"grid"});const u=s.lastAutoTable?.finalY||130,i=computeAverage(o.notes||{},t);s.setFontSize(14),s.text(`Moyenne générale : ${i} /10`,c,u+24);const m=u+64;if(s.setFontSize(11),s.text("Signature enseignant :",l-c-200,m),STORE.sigDataUrl)try{s.addImage(STORE.sigDataUrl,"PNG",l-c-140,m-12,120,48)}catch(e){try{s.addImage(STORE.sigDataUrl,"JPEG",l-c-140,m-12,120,48)}catch(e){}}else s.line(l-c-160,m+8,l-c-40,m+8);const g=s.output("arraybuffer"),C=`Fiche_${o.lastName||""}_${o.firstName||""}_${currentClass}.pdf`.replace(/\s+/g,"_");r.file(C,g)}const n=await r.generateAsync({type:"blob"});saveAs(n,`Fiches_${currentCourse}_${currentClass}.zip`.replace(/\s+/g,"_"))})),logoInput.addEventListener("change",(async e=>{const t=e.target.files[0];if(!t)return;const r=await fileToDataUrl(t);STORE.logoDataUrl=r,saveStore()})),sigInput.addEventListener("change",(async e=>{const t=e.target.files[0];if(!t)return;const r=await fileToDataUrl(t);STORE.sigDataUrl=r,saveStore()})),searchBox.addEventListener("input",renderTable),selectCourse.addEventListener("change",(()=>{currentCourse=selectCourse.value,populateClasses()})),selectClass.addEventListener("change",(()=>{currentClass=selectClass.value,updateContext(),renderSubjects(),renderTable()})),init()</script>
<script>var motDePasse=prompt("Entrer le mot de pass pour accéder au cours :");"Fatima"!==motDePasse&&(alert("mot de pass incorrect !"),window.location.href="https://www.google.com")</script>
</body>
</html>
