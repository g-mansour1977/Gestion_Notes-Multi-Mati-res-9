<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gestion des Notes — Bleu/Blanc (Autonome)</title>

<!-- jsPDF & AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
<!-- JSZip & FileSaver for ZIP export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:#f4f8ff;color:#06243a}
  .container{max-width:1200px;margin:18px auto;padding:16px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff}
  .brand{display:flex;align-items:center;gap:12px}
  .logo-inline{display:flex;gap:8px;align-items:center}
  .logo-inline img{width:52px;height:52px;border-radius:6px;background:#fff;padding:6px;object-fit:contain}
  .brand h1{font-size:18px;margin:0}
  .top-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .top-actions input[type="file"]{display:inline-block}
  .top-actions button{padding:8px 12px;border-radius:8px;border:0;background:#fff;color:#1e40af;font-weight:700;cursor:pointer}
  .grid{display:grid;grid-template-columns:380px 1fr;gap:16px;margin-top:18px}
  @media(max-width:920px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 8px 22px rgba(15,23,42,.06)}
  .small-label{display:block;font-weight:700;margin-bottom:6px;color:#123049}
  input[type=text],input[type=number],select{padding:8px;border-radius:8px;border:1px solid #e6eefc;width:100%}
  .form-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
  .notes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:10px}
  .note-item{display:flex;flex-direction:column}
  .note-item label{font-weight:600;font-size:13px;margin-bottom:6px;color:#23475a}
  .actions{display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid #2563eb;color:#2563eb}
  .btn.warn{background:#ef4444}
  .btn.neutral{background:#0ea5e9}
  .avg-box{margin-left:auto;font-weight:800;color:#0f172a}
  .table-wrap{overflow:auto;margin-top:10px}
  table{width:100%;border-collapse:collapse;min-width:820px}
  th,td{padding:8px;border-bottom:1px solid #eef6ff;text-align:center}
  thead th{background:#f1f7ff;font-weight:800;position:sticky;top:0}
  tbody tr:hover{background:#f8fafc;cursor:pointer}
  tbody tr.selected{background:#fff7cc}
  .context-badge{display:inline-block;background:#e6f0ff;color:#08325a;padding:6px 10px;border-radius:999px;font-weight:700;margin-left:8px}
  footer{padding:12px;text-align:center;color:#5b6b7a;margin-top:18px}
  @media(max-width:700px){.notes-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}}
  .col-actions{position:sticky;right:0;background:#fff}
  .mini{padding:4px 8px;border-radius:6px;font-weight:700;border:1px solid #dbeafe;background:#eff6ff;color:#1d4ed8;cursor:pointer}
</style>
</head>
<body>
  <div class="container">
    <header class="topbar">
      <div class="brand">
        <div class="logo-inline">
          <!-- Livre ouvert bleu -->
          <svg id="logoBook" width="52" height="52" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" style="border-radius:6px;background:#fff;padding:6px">
            <rect rx="10" width="64" height="64" fill="#ffffff00"/>
            <path d="M8 14c8-4 18-4 28 0 10-4 20-4 28 0v32c-8-4-18-4-28 0-10-4-20-4-28 0V14z" fill="#1e3a8a"/>
            <path d="M12 18c6-2.5 14-2.5 22 0 8-2.5 16-2.5 22 0v24c-6-2.5-14-2.5-22 0C26 39.5 18 39.5 12 37V18z" fill="#3b82f6"/>
          </svg>
          <!-- Drapeau Sénégal -->
          <svg id="logoSen" width="36" height="24" viewBox="0 0 15 10" xmlns="http://www.w3.org/2000/svg" style="border-radius:4px;overflow:visible">
            <rect width="5" height="10" x="0" y="0" fill="#009E60"/>
            <rect width="5" height="10" x="5" y="0" fill="#FDEF42"/>
            <rect width="5" height="10" x="10" y="0" fill="#CE1126"/>
            <polygon points="7.5,3.5 8.1,4.9 9.7,5 8.5,6.1 8.9,7.7 7.5,6.8 6.1,7.7 6.5,6.1 5.3,5 6.9,4.9" fill="#006400"/>
          </svg>
        </div>
        <div>
          <h1>Gestion des Notes — Bleu / Blanc</h1>
          <div style="font-size:13px;opacity:0.95">Primaire • Collège • Lycée — matières par classe</div>
        </div>
      </div>

      <div class="top-actions">
        <label style="color:#fff;font-weight:700">Logo (PDF)</label>
        <input id="logoInput" type="file" accept="image/*">
        <label style="color:#fff;font-weight:700">Signature</label>
        <input id="sigInput" type="file" accept="image/*">
        <button id="importCsv" class="btn ghost" title="Importer un CSV exporté">Importer CSV</button>
        <button id="exportCsv" class="btn ghost">Exporter CSV</button>
        <button id="exportPdf" class="btn">Exporter PDF (Classe)</button>
        <button id="exportZip" class="btn neutral" title="Toutes les fiches élèves">Exporter fiches (ZIP)</button>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT: form -->
      <section class="card">
        <div style="margin-bottom:8px">
          <label class="small-label">Parcours</label>
          <select id="selectCourse"></select>
        </div>

        <div style="margin-bottom:8px">
          <label class="small-label">Classe</label>
          <select id="selectClass"></select>
        </div>

        <hr style="margin:10px 0">

        <div>
          <div class="form-row">
            <div style="flex:1">
              <label class="small-label">Prénom</label>
              <input id="firstName" type="text" placeholder="Prénom">
            </div>
            <div style="flex:1">
              <label class="small-label">Nom</label>
              <input id="lastName" type="text" placeholder="Nom">
            </div>
          </div>

          <div class="form-row">
            <div style="width:130px">
              <label class="small-label">Sexe</label>
              <select id="sex"><option>Garçon</option><option>Fille</option></select>
            </div>
            <div style="width:110px">
              <label class="small-label">Âge</label>
              <input id="age" type="number" min="4" max="25" value="10">
            </div>
            <div style="flex:1">
              <label class="small-label">Scolarité</label>
              <select id="schooling"><option>Régulier</option><option>Redoublant</option></select>
            </div>
          </div>

          <h4 style="margin-top:12px">Matières — saisie des notes</h4>
          <div id="notesGrid" class="notes-grid" aria-live="polite"></div>

          <div class="actions">
            <button id="btnAdd" class="btn">Ajouter / Enregistrer</button>
            <button id="btnUpdate" class="btn ghost" disabled>Mettre à jour</button>
            <button id="btnDelete" class="btn warn" disabled>Supprimer</button>
            <button id="btnStudentPdf" class="btn neutral" disabled>Fiche élève (PDF)</button>
            <div class="avg-box" id="avgBox">Moyenne : — /10</div>
          </div>
        </div>
      </section>

      <!-- RIGHT: table -->
      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h3 style="margin:0">Élèves <span id="contextBadge" class="context-badge"></span></h3>
          <div>
            <input id="search" placeholder="Rechercher nom/prénom" style="padding:8px;border-radius:8px;border:1px solid #e6eefc">
          </div>
        </div>

        <div class="table-wrap" style="margin-top:10px">
          <table id="studentsTable">
            <thead><tr id="tableHead"></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer>Les données sont stockées localement dans ton navigateur (localStorage).</footer>
  </div>

<script>
/* ========================= SUBJECTS by course/class =========================
   Each subject: {code,label,max,coef?}
   Primaire: average computed by sum(notes)/sum(max) * 20
   Collège/Lycée: average computed by (sum((note/max)*coef)/sum(coef)) * 20
*/
const SUBJECTS = {
  "Primaire": {
    classes: ["CI","CP","CE1","CE2","CM1","CM2"],
    byClass: {
      CI: [
        {code:"PE", label:"PE", max:10},
        {code:"ECR", label:"Écr", max:10},
        {code:"COPIE", label:"Copie", max:10},
        {code:"AUTD", label:"Autodic", max:10},
        {code:"LECT", label:"Lect", max:10},
        {code:"CHANT", label:"Chant", max:10},
        {code:"NUM", label:"Num", max:10},
        {code:"MES", label:"Mes", max:10},
        {code:"GEOM", label:"Géom", max:10},
        {code:"RP", label:"RP", max:10},
        {code:"HIST", label:"Hist", max:10},
        {code:"GEO", label:"Géo", max:10},
        {code:"IST", label:"IST", max:10},
        {code:"VE", label:"VE", max:10},
        {code:"VM", label:"VM", max:10},
        {code:"AR", label:"AR", max:10},
        {code:"AP", label:"AP", max:10}
      ],
      CP: [], // copy CI
      CE1: [
        {code:"LCR", label:"LCR", max:40},
        {code:"LCC", label:"LCC", max:60},
        {code:"LECT", label:"LECT", max:10},
        {code:"MR", label:"MR", max:40},
        {code:"MC", label:"MC", max:60},
        {code:"DMR", label:"DMR", max:24},
        {code:"DMC", label:"DMC", max:16},
        {code:"EDDR", label:"EDDR", max:24},
        {code:"EDDC", label:"EDDC", max:16},
        {code:"AR", label:"AR", max:10},
        {code:"AP", label:"AP", max:10}
      ],
      CE2: [], // copy CE1
      CM1: [
        {code:"LCR", label:"LCR", max:40},
        {code:"LCC", label:"LCC", max:60},
        {code:"MR", label:"MR", max:40},
        {code:"MC", label:"MC", max:60},
        {code:"DM", label:"DM", max:40},
        {code:"EDD", label:"EDD", max:40},
        {code:"AR", label:"AR", max:10},
        {code:"AP", label:"AP", max:10}
      ],
      CM2: [] // copy CM1
    }
  },

  "Collège": {
    classes: ["6e","5e","4e","3e"],
    byClass: {
      "6e": [
        {code:"FR_RED", label:"Français — Rédaction", max:20, coef:2},
        {code:"FR_TSQ", label:"Français — TSQ", max:20, coef:1},
        {code:"FR_ORTH", label:"Français — Orthographe", max:20, coef:1},
        {code:"MATH", label:"Mathématiques", max:20, coef:3},
        {code:"ANG", label:"Anglais", max:20, coef:2},
        {code:"HG", label:"Histoire-Géo", max:20, coef:2},
        {code:"ESP", label:"Espagnol", max:20, coef:2},
        {code:"PC", label:"Physique-Chimie", max:20, coef:2},
        {code:"SVT", label:"SVT", max:20, coef:2},
        {code:"EPS", label:"EPS", max:20, coef:2},
        {code:"IC", label:"Informatique (IC)", max:20, coef:1},
        {code:"MUS", label:"Musique", max:20, coef:1},
        {code:"COND", label:"Conduite", max:20, coef:1}
      ],
      "5e": [], "4e": [], "3e": []
    }
  },

  "Lycée": {
    classes: ["2nde","1ère","Terminale"],
    byClass: {
      "2nde": [
        {code:"FR", label:"Français", max:20, coef:1},
        {code:"PHIL", label:"Philosophie", max:20, coef:1},
        {code:"MATH", label:"Mathématiques", max:20, coef:1},
        {code:"SVT", label:"SVT", max:20, coef:1},
        {code:"PC", label:"Physique-Chimie", max:20, coef:1},
        {code:"HG", label:"Histoire-Géo", max:20, coef:1},
        {code:"ANG", label:"Anglais", max:20, coef:1},
        {code:"EPS", label:"EPS", max:20, coef:1}
      ],
      "1ère": [], "Terminale": []
    }
  }
};

/* copy-shared class lists */
SUBJECTS.Primaire.byClass.CP = JSON.parse(JSON.stringify(SUBJECTS.Primaire.byClass.CI));
SUBJECTS.Primaire.byClass.CE2 = JSON.parse(JSON.stringify(SUBJECTS.Primaire.byClass.CE1));
SUBJECTS.Primaire.byClass.CM2 = JSON.parse(JSON.stringify(SUBJECTS.Primaire.byClass.CM1));
["5e","4e","3e"].forEach(c => { if(SUBJECTS.Collège.byClass[c].length===0) SUBJECTS.Collège.byClass[c] = JSON.parse(JSON.stringify(SUBJECTS.Collège.byClass["6e"])); });
["1ère","Terminale"].forEach(c => { if(SUBJECTS.Lycée.byClass[c].length===0) SUBJECTS.Lycée.byClass[c] = JSON.parse(JSON.stringify(SUBJECTS.Lycée.byClass["2nde"])); });

/* ================= STORAGE model ================= */
const STORAGE_KEY = "grades_app_autonome_v2"; // bump version for new features
let STORE = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
if(!STORE) { STORE = { records: {}, logoDataUrl: null, sigDataUrl: null }; localStorage.setItem(STORAGE_KEY, JSON.stringify(STORE)); }

/* ================ UI elements ================ */
const selectCourse = document.getElementById("selectCourse");
const selectClass = document.getElementById("selectClass");
const notesGrid = document.getElementById("notesGrid");
const tableHead = document.getElementById("tableHead");
const studentsTbody = document.querySelector("#studentsTable tbody");
const contextBadge = document.getElementById("contextBadge");
const avgBox = document.getElementById("avgBox");

const firstNameEl = document.getElementById("firstName");
const lastNameEl  = document.getElementById("lastName");
const sexEl       = document.getElementById("sex");
const ageEl       = document.getElementById("age");
const schoolEl    = document.getElementById("schooling");

const btnAdd = document.getElementById("btnAdd");
const btnUpdate = document.getElementById("btnUpdate");
const btnDelete = document.getElementById("btnDelete");
const btnStudentPdf = document.getElementById("btnStudentPdf");
const exportCsvBtn = document.getElementById("exportCsv");
const importCsvBtn = document.getElementById("importCsv");
const exportPdfBtn = document.getElementById("exportPdf");
const exportZipBtn = document.getElementById("exportZip");
const logoInput = document.getElementById("logoInput");
const sigInput = document.getElementById("sigInput");
const searchBox = document.getElementById("search");

let currentCourse = null;
let currentClass = null;
let selectedIndex = null;

/* ================ Helpers ================ */
function saveStore(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(STORE)); }
function ensureRecords(course, klass){ STORE.records[course] ??= {}; STORE.records[course][klass] ??= []; }
function subjectsFor(course, klass){ return (SUBJECTS[course]?.byClass[klass] || []); }

/* Average computation */
function computeAverage(notesObj, subjectsArr){
  if(!subjectsArr || subjectsArr.length===0) return 0;
  const isPrimaire = currentCourse === "Primaire";
  if(isPrimaire){
    let sumNotes=0, sumMax=0;
    for(const s of subjectsArr){ const v = Number(notesObj[s.code] ?? 0); sumNotes += v; sumMax += Number(s.max || 0); }
    if(sumMax===0) return 0;
    return Math.round((sumNotes / sumMax * 20) * 100) / 100;
  } else {
    let weighted=0, sumCoef=0;
    for(const s of subjectsArr){
      const coef = Number(s.coef ?? 1);
      const v = Number(notesObj[s.code] ?? 0);
      const max = Number(s.max || 1);
      const frac = max>0 ? (v / max) : 0;
      weighted += frac * coef;
      sumCoef += coef;
    }
    if(sumCoef===0) return 0;
    return Math.round(((weighted / sumCoef) * 20) * 100) / 100;
  }
}

/* Ranking: standard competition ranking (1,1,3,4) for ties) */
function assignRanks(list, subjectsArr){
  const withAvg = list.map((s, idx)=>({ ...s, __avg: computeAverage(s.notes || {}, subjectsArr), __origIdx: idx }));
  withAvg.sort((a,b)=> b.__avg - a.__avg);
  let ranks = new Array(withAvg.length);
  let currentRank = 1;
  for(let i=0;i<withAvg.length;i++){
    if(i>0 && withAvg[i].__avg === withAvg[i-1].__avg){
      ranks[i] = ranks[i-1];
    } else {
      ranks[i] = currentRank;
    }
    currentRank++;
  }
  const rankMap = {};
  withAvg.forEach((w,i)=> rankMap[w.__origIdx] = { avg: w.__avg, rank: ranks[i] });
  return rankMap;
}
function rankSuffix(n){ if(!n||n<1) return ""; return (n===1?"1er":n+"e"); }

/* ================ Initialize selectors ================ */
function init(){
  selectCourse.innerHTML = "";
  for(const c of Object.keys(SUBJECTS)){
    const op = document.createElement("option"); op.value = c; op.textContent = c; selectCourse.appendChild(op);
  }
  currentCourse = selectCourse.value;
  populateClasses();
}
function populateClasses(){
  selectClass.innerHTML = "";
  const arr = SUBJECTS[currentCourse].classes || [];
  arr.forEach(c => { const op = document.createElement("option"); op.value=c; op.textContent=c; selectClass.appendChild(op); });
  currentClass = selectClass.value;
  updateContext();
  renderSubjects();
  renderTable();
}
function updateContext(){ contextBadge.textContent = `${currentCourse} — ${currentClass}`; }

/* ================ Render subjects inputs ================ */
function renderSubjects(){
  notesGrid.innerHTML = "";
  const subs = subjectsFor(currentCourse, currentClass);
  subs.forEach(s => {
    const wrap = document.createElement("div"); wrap.className = "note-item";
    const lbl = document.createElement("label"); lbl.textContent = `${s.label} (max ${s.max})`;
    const inp = document.createElement("input"); inp.type = "number"; inp.min = 0; inp.max = s.max; inp.step = "0.01"; inp.dataset.code = s.code;
    wrap.appendChild(lbl); wrap.appendChild(inp);
    notesGrid.appendChild(wrap);
    inp.addEventListener("input", computeAndShowAvg);
  });
  computeAndShowAvg();
  buildTableHead();
}
function buildTableHead(){
  tableHead.innerHTML = "";
  const base = ["Prénom","Nom","Sexe","Âge","Scol"];
  base.forEach(h => { const th = document.createElement("th"); th.textContent = h; th.dataset.key = h; th.style.cursor = "pointer"; th.addEventListener("click", ()=>sortByHeader(h)); tableHead.appendChild(th); });
  const subs = subjectsFor(currentCourse, currentClass);
  subs.forEach(s=>{ const th = document.createElement("th"); th.textContent = s.label; th.dataset.code = s.code; th.style.cursor = "pointer"; th.addEventListener("click", ()=>sortByHeader(s.code)); tableHead.appendChild(th); });
  const thm = document.createElement("th"); thm.textContent = "Moyenne"; thm.style.cursor = "pointer"; thm.addEventListener("click", ()=>sortByHeader("__avg")); tableHead.appendChild(thm);
  const thr = document.createElement("th"); thr.textContent = "Rang"; tableHead.appendChild(thr);
}

/* ================ Students table rendering (sorted by avg desc by default) ================ */
function renderTable(){
  ensureRecords(currentCourse, currentClass);
  const arr = STORE.records[currentCourse][currentClass];
  studentsTbody.innerHTML = "";
  const subs = subjectsFor(currentCourse, currentClass);

  const rankMap = assignRanks(arr, subs);
  const rows = arr.map((r, idx) => ({ idx, rec: r, avg: rankMap[idx]?.avg ?? computeAverage(r.notes||{}, subs), rank: rankMap[idx]?.rank ?? 0 }));
  rows.sort((a,b)=> (b.avg - a.avg) || (a.rec.lastName||"").localeCompare(b.rec.lastName||""));

  const q = (searchBox.value || "").trim().toLowerCase();

  rows.forEach((rObj)=>{
    const r = rObj.rec; const avg = rObj.avg; const rank = rObj.rank; const fullname = `${r.firstName} ${r.lastName}`.toLowerCase();
    if(q && !fullname.includes(q) && !(r.firstName||"").toLowerCase().includes(q) && !(r.lastName||"").toLowerCase().includes(q)) return;
    const tr = document.createElement("tr"); tr.dataset.index = rObj.idx;
    const cells = [
      `<td>${r.firstName||""}</td>`,
      `<td>${r.lastName||""}</td>`,
      `<td>${r.gender||""}</td>`,
      `<td>${r.age ?? ""}</td>`,
      `<td>${r.schooling||""}</td>`
    ];
    for(const s of subs) cells.push(`<td>${r.notes?.[s.code] ?? ""}</td>`);
    cells.push(`<td>${avg}</td>`);
    cells.push(`<td>${rankSuffix(rank)}</td>`);
    tr.innerHTML = cells.join("");
    tr.addEventListener("click", ()=> selectStudentByIndex(rObj.idx));
    studentsTbody.appendChild(tr);
  });
  updateContext();
}

/* select student by store index */
function selectStudentByIndex(storeIndex){
  ensureRecords(currentCourse, currentClass);
  const arr = STORE.records[currentCourse][currentClass];
  const st = arr[storeIndex];
  if(!st) return;
  selectedIndex = storeIndex;
  firstNameEl.value = st.firstName || "";
  lastNameEl.value = st.lastName || "";
  sexEl.value = st.gender || "Garçon";
  ageEl.value = st.age || "";
  schoolEl.value = st.schooling || "Régulier";
  const subs = subjectsFor(currentCourse, currentClass);
  subs.forEach(s=>{
    const inp = notesGrid.querySelector(`input[data-code="${s.code}"]`);
    if(inp) inp.value = st.notes?.[s.code] ?? "";
  });
  btnUpdate.disabled = false; btnDelete.disabled = false; btnStudentPdf.disabled = false;
  $$("#studentsTable tbody tr").forEach(tr=>tr.classList.remove("selected"));
  const row = $(`#studentsTable tbody tr[data-index="${storeIndex}"]`);
  if(row) row.classList.add("selected");
  computeAndShowAvg();
}

/* clear form */
function clearForm(){
  selectedIndex = null;
  firstNameEl.value = ""; lastNameEl.value = ""; sexEl.value = "Garçon"; ageEl.value = ""; schoolEl.value = "Régulier";
  notesGrid.querySelectorAll("input[data-code]").forEach(i=>i.value = "");
  btnUpdate.disabled = true; btnDelete.disabled = true; btnStudentPdf.disabled = true;
  $$("#studentsTable tbody tr").forEach(tr=>tr.classList.remove("selected"));
  computeAndShowAvg();
}

/* ================ CRUD operations ================ */
btnAdd.addEventListener("click", ()=>{
  const f = (firstNameEl.value || "").trim(), l = (lastNameEl.value || "").trim();
  if(!f || !l){ alert("Prénom et Nom requis"); return; }
  const subs = subjectsFor(currentCourse, currentClass);
  const notes = {};
  for(const s of subs){
    const inp = notesGrid.querySelector(`input[data-code="${s.code}"]`);
    const v = inp && inp.value !== "" ? Number(inp.value) : 0;
    notes[s.code] = Math.max(0, Math.min(s.max, v));
  }
  ensureRecords(currentCourse, currentClass);
  STORE.records[currentCourse][currentClass].push({
    firstName: f, lastName: l, gender: sexEl.value, age: ageEl.value, schooling: schoolEl.value, notes
  });
  saveStore();
  renderTable();
  clearForm();
});
btnUpdate.addEventListener("click", ()=>{
  if(selectedIndex === null){ alert("Sélectionne un élève"); return; }
  const f = (firstNameEl.value || "").trim(), l = (lastNameEl.value || "").trim();
  if(!f || !l){ alert("Prénom et Nom requis"); return; }
  const subs = subjectsFor(currentCourse, currentClass);
  const notes = {};
  for(const s of subs){
    const inp = notesGrid.querySelector(`input[data-code="${s.code}"]`);
    const v = inp && inp.value !== "" ? Number(inp.value) : 0;
    notes[s.code] = Math.max(0, Math.min(s.max, v));
  }
  ensureRecords(currentCourse, currentClass);
  STORE.records[currentCourse][currentClass][selectedIndex] = {
    firstName: f, lastName: l, gender: sexEl.value, age: ageEl.value, schooling: schoolEl.value, notes
  };
  saveStore();
  renderTable();
  clearForm();
});
btnDelete.addEventListener("click", ()=>{
  if(selectedIndex === null){ alert("Sélectionne un élève"); return; }
  if(!confirm("Supprimer l'élève sélectionné ?")) return;
  ensureRecords(currentCourse, currentClass);
  STORE.records[currentCourse][currentClass].splice(selectedIndex,1);
  saveStore();
  renderTable();
  clearForm();
});

/* ================ Preview avg ================ */
function computeAndShowAvg(){
  const subs = subjectsFor(currentCourse, currentClass);
  const notes = {};
  subs.forEach(s=> {
    const inp = notesGrid.querySelector(`input[data-code="${s.code}"]`);
    notes[s.code] = (inp && inp.value !== "") ? Number(inp.value) : 0;
  });
  const avg = computeAverage(notes, subs);
  avgBox.textContent = `Moyenne : ${avg} /20`;
}

/* ================ CSV export (class) ================ */
exportCsvBtn.addEventListener("click", ()=>{
  ensureRecords(currentCourse, currentClass);
  const arr = STORE.records[currentCourse][currentClass] || [];
  if(arr.length===0){ alert("Aucun élève à exporter"); return; }
  const subs = subjectsFor(currentCourse, currentClass);
  const rankMap = assignRanks(arr, subs);
  const header = ["Prénom","Nom","Sexe","Âge","Scol", ...subs.map(s=>s.label), "Moyenne", "Rang"];
  const lines = [ header.join(";") ];
  arr.forEach((r, idx) => {
    const avg = rankMap[idx]?.avg ?? computeAverage(r.notes||{}, subs);
    const rank = rankMap[idx]?.rank ?? 0;
    const row = [ r.firstName, r.lastName, r.gender, r.age ?? "", r.schooling ];
    for(const s of subs) row.push( r.notes?.[s.code] ?? "" );
    row.push(avg);
    row.push(rankSuffix(rank));
    lines.push(row.join(";"));
  });
  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `Notes_${currentCourse}_${currentClass}.csv`.replace(/\s+/g,'_'); a.click();
  URL.revokeObjectURL(a.href);
});

/* ================ CSV import (class) ================ */
importCsvBtn.addEventListener("click", ()=>{
  const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.csv,text/csv';
  inp.onchange = async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(lines.length<2){ alert('CSV vide'); return; }
    const header = lines[0].split(';');
    const subs = subjectsFor(currentCourse, currentClass);
    const expected = ["Prénom","Nom","Sexe","Âge","Scol", ...subs.map(s=>s.label)];
    // tolérer colonnes Moyenne / Rang présentes
    const minLen = expected.length; if(header.length < minLen){ alert('Colonnes manquantes. Exporte un CSV depuis l\'app pour avoir le bon format.'); return; }
    ensureRecords(currentCourse, currentClass);
    const newRecords = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(';'); if(cols.length < minLen) continue;
      const rec = {
        firstName: cols[0]||'', lastName: cols[1]||'', gender: cols[2]||'', age: cols[3]||'', schooling: cols[4]||'', notes: {}
      };
      subs.forEach((s, idx)=>{ const val = Number(cols[5+idx] || 0); rec.notes[s.code] = isNaN(val)?0:val; });
      if(rec.firstName || rec.lastName) newRecords.push(rec);
    }
    STORE.records[currentCourse][currentClass] = newRecords;
    saveStore();
    renderTable();
    clearForm();
    alert(`Import terminé: ${newRecords.length} élève(s).`);
  };
  inp.click();
});

/* ================ PDF export (class) ================ */
exportPdfBtn.addEventListener("click", async ()=>{
  ensureRecords(currentCourse, currentClass);
  const arr = STORE.records[currentCourse][currentClass] || [];
  if(arr.length===0){ alert("Aucun élève à exporter"); return; }
  const subs = subjectsFor(currentCourse, currentClass);
  const rankMap = assignRanks(arr, subs);
  const rows = arr.map((r, idx) => ({ idx, rec: r, avg: rankMap[idx]?.avg ?? computeAverage(r.notes||{}, subs), rank: rankMap[idx]?.rank ?? 0 }));
  rows.sort((a,b)=> b.avg - a.avg);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 36;

  // Header bar
  doc.setFillColor(37,99,235); doc.rect(0,0,pageW,64,"F");
  if(STORE.logoDataUrl){ try{ doc.addImage(STORE.logoDataUrl, 'PNG', margin, 10, 44, 44); } catch(e){ try{ doc.addImage(STORE.logoDataUrl, 'JPEG', margin,10,44,44);}catch(e){} } }
  const flagSvg = `<svg xmlns='http://www.w3.org/2000/svg' width='36' height='24'><rect width='12' height='24' x='0' y='0' fill='#009E60'/><rect width='12' height='24' x='12' y='0' fill='#FDEF42'/><rect width='12' height='24' x='24' y='0' fill='#CE1126'/><polygon points='18,7 18.6,9.2 20.6,9.4 19.3,10.6 19.7,12.6 18,11.5 16.3,12.6 16.7,10.6 15.4,9.4 17.4,9.2' fill='#006400'/></svg>`;
  const flagDataUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(flagSvg);
  try{ doc.addImage(flagDataUrl,'SVG', pageW - margin - 52, 10, 44, 29); } catch(e){}

  doc.setFontSize(18); doc.setTextColor(255,255,255);
  doc.text(`Fiche de notes — ${currentCourse} / ${currentClass}`, pageW/2, 28, { align: "center" });
  doc.setFontSize(10); doc.text(`Généré le ${new Date().toLocaleString()}`, pageW/2, 44, { align: "center" });

  const head = [["Prénom","Nom","Sexe","Âge","Scol", ...subs.map(s=>s.label), "Moyenne", "Rang"]];
  const body = rows.map(rObj => {
    const r = rObj.rec;
    return [ r.firstName, r.lastName, r.gender, String(r.age ?? ""), r.schooling, ...subs.map(s => String(r.notes?.[s.code] ?? "")), String(rObj.avg), rankSuffix(rObj.rank) ];
  });

  doc.autoTable({
    startY: 86,
    head: head,
    body: body,
    styles: { fontSize: 9, halign: 'center', valign: 'middle' },
    headStyles: { fillColor: [37,99,235], textColor: 255 },
    alternateRowStyles: { fillColor: [245,246,250] },
    margin: { left: margin, right: margin },
    theme: 'grid'
  });

  const finalY = doc.lastAutoTable?.finalY || 86;
  const footerY = finalY + 28;
  doc.setFontSize(11); doc.setTextColor(0,0,0);
  doc.text("Signature enseignant :", pageW - margin - 200, footerY);
  if(STORE.sigDataUrl){
    try{ doc.addImage(STORE.sigDataUrl, 'PNG', pageW - margin - 140, footerY-12, 120, 48); } catch(e){ try{ doc.addImage(STORE.sigDataUrl, 'JPEG', pageW - margin - 140, footerY-12, 120, 48);}catch(e){} }
  } else { doc.line(pageW - margin - 160, footerY+8, pageW - margin - 40, footerY+8); }

  doc.save(`Notes_${currentCourse}_${currentClass}.pdf`.replace(/\s+/g,'_'));
});

/* ================ Fiche élève (PDF individuel) ================ */
btnStudentPdf.addEventListener('click', ()=>{
  if(selectedIndex===null){ alert('Sélectionne un élève'); return; }
  ensureRecords(currentCourse, currentClass);
  const arr = STORE.records[currentCourse][currentClass];
  const rec = arr[selectedIndex];
  const subs = subjectsFor(currentCourse, currentClass);
  const avg = computeAverage(rec.notes||{}, subs);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 48;

  doc.setFillColor(37,99,235); doc.rect(0,0,pageW,68,"F");
  if(STORE.logoDataUrl){ try{ doc.addImage(STORE.logoDataUrl, 'PNG', margin, 14, 40, 40); } catch(e){ try{ doc.addImage(STORE.logoDataUrl, 'JPEG', margin,14,40,40);}catch(e){} } }
  const flagSvg = `<svg xmlns='http://www.w3.org/2000/svg' width='36' height='24'><rect width='12' height='24' x='0' y='0' fill='#009E60'/><rect width='12' height='24' x='12' y='0' fill='#FDEF42'/><rect width='12' height='24' x='24' y='0' fill='#CE1126'/><polygon points='18,7 18.6,9.2 20.6,9.4 19.3,10.6 19.7,12.6 18,11.5 16.3,12.6 16.7,10.6 15.4,9.4 17.4,9.2' fill='#006400'/></svg>`;
  const flagDataUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(flagSvg);
  try{ doc.addImage(flagDataUrl,'SVG', pageW - margin - 48, 14, 40, 28); } catch(e){}

  doc.setFontSize(18); doc.setTextColor(255,255,255);
  doc.text(`Fiche élève — ${currentCourse} / ${currentClass}`, pageW/2, 30, { align: 'center' });
  doc.setFontSize(10); doc.text(`Généré le ${new Date().toLocaleString()}`, pageW/2, 50, { align: 'center' });

  // Infos élève
  doc.setTextColor(0,0,0); doc.setFontSize(12);
  const infoY = 96;
  doc.text(`Nom : ${rec.lastName}  |  Prénom : ${rec.firstName}`, margin, infoY);
  doc.text(`Sexe : ${rec.gender || ''}  |  Âge : ${rec.age || ''}  |  Scol : ${rec.schooling || ''}`, margin, infoY+18);

  // Notes tableau
  const head = [["Matière","Note","Barème"]];
  const body = subs.map(s=> [s.label, String(rec.notes?.[s.code] ?? ''), String(s.max)]);
  doc.autoTable({
    startY: infoY + 34,
    head, body,
    styles: { fontSize: 10, halign:'center' },
    headStyles: { fillColor: [37,99,235], textColor: 255 },
    alternateRowStyles: { fillColor: [245,246,250] },
    margin: { left: margin, right: margin },
    theme: 'grid'
  });

  const afterTableY = doc.lastAutoTable?.finalY || (infoY+34);
  doc.setFontSize(14); doc.text(`Moyenne générale : ${avg} /20`, margin, afterTableY + 24);

  // Signature
  const sigY = afterTableY + 64; doc.setFontSize(11); doc.text('Signature enseignant :', pageW - margin - 200, sigY);
  if(STORE.sigDataUrl){ try{ doc.addImage(STORE.sigDataUrl, 'PNG', pageW - margin - 140, sigY-12, 120, 48); } catch(e){ try{ doc.addImage(STORE.sigDataUrl, 'JPEG', pageW - margin - 140, sigY-12, 120, 48);}catch(e){} } }
  else { doc.line(pageW - margin - 160, sigY+8, pageW - margin - 40, sigY+8); }

  const fileName = `Fiche_${rec.lastName || ''}_${rec.firstName || ''}_${currentClass}.pdf`.replace(/\s+/g,'_');
  doc.save(fileName);
});

/* ================ Export fiches ZIP (PDF individuels) ================ */
exportZipBtn.addEventListener('click', async ()=>{
  ensureRecords(currentCourse, currentClass);
  const arr = STORE.records[currentCourse][currentClass] || [];
  if(arr.length===0){ alert('Aucun élève'); return; }
  const subs = subjectsFor(currentCourse, currentClass);
  const zip = new JSZip();

  for(let i=0;i<arr.length;i++){
    const rec = arr[i];
    // Générer un PDF en mémoire (Uint8Array)
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
    const pageW = doc.internal.pageSize.getWidth();
    const margin = 48;

    doc.setFillColor(37,99,235); doc.rect(0,0,pageW,68,"F");
    if(STORE.logoDataUrl){ try{ doc.addImage(STORE.logoDataUrl, 'PNG', margin, 14, 40, 40); } catch(e){ try{ doc.addImage(STORE.logoDataUrl, 'JPEG', margin,14,40,40);}catch(e){} } }
    const flagSvg = `<svg xmlns='http://www.w3.org/2000/svg' width='36' height='24'><rect width='12' height='24' x='0' y='0' fill='#009E60'/><rect width='12' height='24' x='12' y='0' fill='#FDEF42'/><rect width='12' height='24' x='24' y='0' fill='#CE1126'/><polygon points='18,7 18.6,9.2 20.6,9.4 19.3,10.6 19.7,12.6 18,11.5 16.3,12.6 16.7,10.6 15.4,9.4 17.4,9.2' fill='#006400'/></svg>`;
    const flagDataUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(flagSvg);
    try{ doc.addImage(flagDataUrl,'SVG', pageW - margin - 48, 14, 40, 28); } catch(e){}

    doc.setFontSize(18); doc.setTextColor(255,255,255);
    doc.text(`Fiche élève — ${currentCourse} / ${currentClass}`, pageW/2, 30, { align: 'center' });
    doc.setFontSize(10); doc.text(`Généré le ${new Date().toLocaleString()}`, pageW/2, 50, { align: 'center' });

    const avg = computeAverage(rec.notes||{}, subs);
    doc.setTextColor(0,0,0); doc.setFontSize(12);
    const infoY = 96;
    doc.text(`Nom : ${rec.lastName}  |  Prénom : ${rec.firstName}`, margin, infoY);
    doc.text(`Sexe : ${rec.gender || ''}  |  Âge : ${rec.age || ''}  |  Scol : ${rec.schooling || ''}`, margin, infoY+18);

    const head = [["Matière","Note","Barème"]];
    const body = subs.map(s=> [s.label, String(rec.notes?.[s.code] ?? ''), String(s.max)]);
    doc.autoTable({ startY: infoY + 34, head, body, styles: { fontSize: 10, halign:'center' }, headStyles: { fillColor: [37,99,235], textColor: 255 }, alternateRowStyles: { fillColor: [245,246,250] }, margin: { left: margin, right: margin }, theme: 'grid' });

    const afterTableY = doc.lastAutoTable?.finalY || (infoY+34);
    doc.setFontSize(14); doc.text(`Moyenne générale : ${avg} /20`, margin, afterTableY + 24);

    const sigY = afterTableY + 64; doc.setFontSize(11); doc.text('Signature enseignant :', pageW - margin - 200, sigY);
    if(STORE.sigDataUrl){ try{ doc.addImage(STORE.sigDataUrl, 'PNG', pageW - margin - 140, sigY-12, 120, 48); } catch(e){ try{ doc.addImage(STORE.sigDataUrl, 'JPEG', pageW - margin - 140, sigY-12, 120, 48);}catch(e){} } }
    else { doc.line(pageW - margin - 160, sigY+8, pageW - margin - 40, sigY+8); }

    const uint8 = doc.output('arraybuffer');
    const safeName = `Fiche_${rec.lastName || ''}_${rec.firstName || ''}_${currentClass}.pdf`.replace(/\s+/g,'_');
    zip.file(safeName, uint8);
  }

  const blob = await zip.generateAsync({ type: 'blob' });
  saveAs(blob, `Fiches_${currentCourse}_${currentClass}.zip`.replace(/\s+/g,'_'));
});

/* ================ Logo & signature upload handling ================ */
logoInput.addEventListener("change", async (ev)=>{ const f = ev.target.files[0]; if(!f) return; const d = await fileToDataUrl(f); STORE.logoDataUrl = d; saveStore(); });
sigInput.addEventListener("change", async (ev)=>{ const f = ev.target.files[0]; if(!f) return; const d = await fileToDataUrl(f); STORE.sigDataUrl = d; saveStore(); });
function fileToDataUrl(file){ return new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload = ()=> res(fr.result); fr.onerror = ()=> rej(); fr.readAsDataURL(file); }); }

/* ================ Search & interactions ================ */
searchBox.addEventListener("input", ()=> renderTable());
selectCourse.addEventListener("change", ()=> { currentCourse = selectCourse.value; populateClasses(); });
selectClass.addEventListener("change", ()=> { currentClass = selectClass.value; updateContext(); renderSubjects(); renderTable(); });

/* sort handling by header click */
let currentSort = { key: "__rank", dir: -1 }; // default sort by rank desc
function sortByHeader(key){
  ensureRecords(currentCourse, currentClass);
  const arr = STORE.records[currentCourse][currentClass];
  const subs = subjectsFor(currentCourse, currentClass);
  if(!arr || !arr.length) return;
  const mapped = arr.map((r, idx)=>({ r, idx, avg: computeAverage(r.notes||{}, subs) }));
  let cmp;
  if(key === "Prénom") cmp = (a,b)=> a.r.firstName.localeCompare(b.r.firstName);
  else if(key === "Nom") cmp = (a,b)=> a.r.lastName.localeCompare(b.r.lastName);
  else if(key === "Sexe") cmp = (a,b)=> (a.r.gender||"").localeCompare(b.r.gender||"");
  else if(key === "Âge") cmp = (a,b)=> (Number(a.r.age||0) - Number(b.r.age||0));
  else if(key === "Scol") cmp = (a,b)=> (a.r.schooling||"").localeCompare(b.r.schooling||"");
  else if(key === "__avg") cmp = (a,b)=> a.avg - b.avg;
  else { cmp = (a,b)=> Number(a.r.notes?.[key]||0) - Number(b.r.notes?.[key]||0); }
  mapped.sort((a,b)=> currentSort.dir * cmp(a,b));
  const newOrder = mapped.map(m=>m.r);
  STORE.records[currentCourse][currentClass] = newOrder; saveStore();
  currentSort.dir = -currentSort.dir; renderTable();
}

/* ================ Utility selectors ================ */
function $(s){ return document.querySelector(s); }
function $$(s){ return Array.from(document.querySelectorAll(s)); }

/* ================ Boot ================ */
(function boot(){
  selectCourse.innerHTML = "";
  for(const c of Object.keys(SUBJECTS)){ const op = document.createElement("option"); op.value=c; op.textContent=c; selectCourse.appendChild(op); }
  currentCourse = selectCourse.value;
  populateClasses();
})();

function populateClasses(){
  selectClass.innerHTML = "";
  const arr = SUBJECTS[currentCourse].classes || [];
  for(const c of arr){ const op = document.createElement("option"); op.value=c; op.textContent=c; selectClass.appendChild(op); }
  currentClass = selectClass.value;
  updateContext();
  renderSubjects();
  renderTable();
}
</script>

 <script>
                var motDePasse = prompt("Entrer le mot de pass pour accéder au cours :")
                 if (motDePasse !== "Fatima") {
                    alert("mot de pass incorrect !");
                    window.location.href = "https://www.google.com"; // redirige ailleurs
                 }
            </script>
</body>
</html>
